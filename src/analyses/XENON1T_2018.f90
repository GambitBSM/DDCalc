MODULE XENON1T_2018

!=======================================================================
! XENON1T 2018 ANALYSIS ROUTINES
! Based upon powerpoint physics.  
!=======================================================================

USE DDTypes
USE DDDetectors

IMPLICIT NONE

CONTAINS


!-----------------------------------------------------------------------
! Initializes a DetectorStruct to the XENON1T 2018 analysis.
! 
FUNCTION XENON1T_2018_Init() RESULT(D)

  IMPLICIT NONE
  TYPE(DetectorStruct) :: D
  INTEGER, PARAMETER :: NE = 101
  INTEGER, PARAMETER :: NBINS = 2
  REAL*8, PARAMETER :: EMIN = 1.5d0
  ! Efficiency curves energy tabulation points

  REAL*8, PARAMETER :: E(NE)                                            &
      =       (/ 1.50000d0, 1.55637d0, 1.61485d0, 1.67553d0, 1.73850d0, 1.80382d0, &
      1.87161d0, 1.94194d0, 2.01491d0, 2.09063d0, 2.16919d0, 2.25070d0, &
      2.33528d0, 2.42303d0, 2.51408d0, 2.60856d0, 2.70658d0, 2.80829d0, &
      2.91382d0, 3.02331d0, 3.13692d0, 3.25480d0, 3.37710d0, 3.50401d0, &
      3.63568d0, 3.77230d0, 3.91405d0, 4.06114d0, 4.21374d0, 4.37209d0, &
      4.53638d0, 4.70684d0, 4.88372d0, 5.06724d0, 5.25765d0, 5.45522d0, &
      5.66021d0, 5.87291d0, 6.09360d0, 6.32258d0, 6.56017d0, 6.80669d0, &
      7.06247d0, 7.32786d0, 7.60322d0, 7.88893d0, 8.18538d0, 8.49297d0, &
      8.81211d0, 9.14325d0, 9.48683d0, 9.84333d0, 10.21320d0, 10.59700d0, &
      10.99520d0, 11.40840d0, 11.83710d0, 12.28190d0, 12.74340d0, &
      13.22230d0, 13.71920d0, 14.23470d0, 14.76960d0, 15.32460d0, &
      15.90050d0, 16.49800d0, 17.11790d0, 17.76120d0, 18.42860d0, &
      19.12110d0, 19.83960d0, 20.58510d0, 21.35870d0, 22.16130d0, &
      22.99410d0, 23.85810d0, 24.75470d0, 25.68490d0, 26.65010d0, &
      27.65150d0, 28.69060d0, 29.76870d0, 30.88730d0, 32.04800d0, &
      33.25230d0, 34.50180d0, 35.79830d0, 37.14360d0, 38.53930d0, &
      39.98750d0, 41.49020d0, 43.04930d0, 44.66700d0, 46.34540d0, &
      48.08700d0, 49.89400d0, 51.76890d0, 53.71420d0, 55.73270d0, &
      57.82700d0, 60.00000d0 /)

  ! Efficiency (total)
  REAL*8, PARAMETER :: EFF0(NE)                                         &
      =       (/ 0.00000d0, 0.00053d0, 0.00105d0, 0.00157d0, 0.00210d0, 0.00265d0, &
      0.00325d0, 0.00390d0, 0.00463d0, 0.00548d0, 0.00649d0, 0.00768d0, &
      0.00911d0, 0.01084d0, 0.01300d0, 0.01564d0, 0.01875d0, 0.02241d0, &
      0.02691d0, 0.03235d0, 0.03828d0, 0.04452d0, 0.04919d0, 0.05370d0, &
      0.05857d0, 0.06430d0, 0.07233d0, 0.08283d0, 0.09409d0, 0.10466d0, &
      0.11536d0, 0.12676d0, 0.13992d0, 0.15755d0, 0.17316d0, 0.18518d0, &
      0.19620d0, 0.20837d0, 0.22101d0, 0.23365d0, 0.24566d0, 0.25415d0, &
      0.26266d0, 0.27527d0, 0.29175d0, 0.30839d0, 0.32239d0, 0.33029d0, &
      0.32792d0, 0.33179d0, 0.33742d0, 0.34265d0, 0.34757d0, 0.35231d0, &
      0.35681d0, 0.36115d0, 0.36544d0, 0.36984d0, 0.37407d0, 0.37801d0, &
      0.38162d0, 0.38483d0, 0.38748d0, 0.38941d0, 0.39087d0, 0.39196d0, &
      0.39299d0, 0.39402d0, 0.39490d0, 0.39564d0, 0.39628d0, 0.39678d0, &
      0.39712d0, 0.39728d0, 0.39724d0, 0.39735d0, 0.39777d0, 0.39833d0, &
      0.39898d0, 0.39968d0, 0.40034d0, 0.40206d0, 0.40184d0, 0.39961d0, &
      0.39550d0, 0.38992d0, 0.38175d0, 0.36546d0, 0.35022d0, 0.32501d0, &
      0.29097d0, 0.25247d0, 0.20424d0, 0.15509d0, 0.11159d0, 0.07528d0, &
      0.04731d0, 0.02584d0, 0.01382d0, 0.00582d0, 0.00241d0 /)

  REAL*8, PARAMETER :: EFF1(NE)                                         &
      =       (/ 0.00000d0, 0.00037d0, 0.00073d0, 0.00109d0, 0.00145d0, 0.00184d0, &
      0.00225d0, 0.00270d0, 0.00321d0, 0.00380d0, 0.00449d0, 0.00532d0, &
      0.00631d0, 0.00751d0, 0.00900d0, 0.01082d0, 0.01298d0, 0.01552d0, &
      0.01863d0, 0.02239d0, 0.02650d0, 0.03082d0, 0.03405d0, 0.03718d0, &
      0.04055d0, 0.04452d0, 0.05007d0, 0.05734d0, 0.06514d0, 0.07246d0, &
      0.07987d0, 0.08776d0, 0.09687d0, 0.10906d0, 0.11985d0, 0.12815d0, &
      0.13572d0, 0.14404d0, 0.15262d0, 0.16107d0, 0.16889d0, 0.17402d0, &
      0.17876d0, 0.18571d0, 0.19442d0, 0.20204d0, 0.20643d0, 0.20519d0, &
      0.19588d0, 0.18855d0, 0.18016d0, 0.16944d0, 0.15658d0, 0.14194d0, &
      0.12595d0, 0.10917d0, 0.09229d0, 0.07593d0, 0.06064d0, 0.04687d0, &
      0.03498d0, 0.02515d0, 0.01736d0, 0.01145d0, 0.00720d0, 0.00432d0, &
      0.00246d0, 0.00133d0, 0.00068d0, 0.00033d0, 0.00015d0, 0.00006d0, &
      0.00003d0, 0.00001d0, 0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, &
      0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, &
      0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, &
      0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, &
      0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0, 0.00000d0 /)

  ! Efficiencies array (2D)
  REAL*8, PARAMETER :: EFF(NE,0:NBINS)                                   &
      = RESHAPE( (/ EFF0(:), EFF1(:), EFF0(:) - EFF1(:) /), SHAPE(EFF))

  CALL SetDetector(D,mass=1300.0d0,time=278.8d0,Nevents_bin=[0,11],     &
                   Backgr_bin=[0.7d0,7.7d0],Nelem=1,Zelem=(/54/),       &
                   NE=NE,E=E,Nbins=NBINS,eff_all=EFF,                   &
                   Emin=EMIN)
!  CALL SetDetector(D,mass=1300.0d0,time=278.8d0,Nevents_tot=11,     &
!                   Backgr_tot=8.4d0,Nelem=1,Zelem=(/54/),       &
!                   NE=NE,E=E,Nbins=NBINS,eff_all=EFF,                   &
!                   Emin=EMIN)
   D%eff_file = '[XENON1T 2018]'
  
END FUNCTION  


! C++ interface wrapper
INTEGER(KIND=C_INT) FUNCTION C_XENON1T_2018_Init() &
 BIND(C,NAME='C_DDCalc_xenon1t_2018_init') 
  USE ISO_C_BINDING, only: C_BOOL, C_INT
  IMPLICIT NONE
  N_Detectors = N_Detectors + 1
  ALLOCATE(Detectors(N_Detectors)%p)
  Detectors(N_Detectors)%p = XENON1T_2018_Init()
  C_XENON1T_2018_Init = N_Detectors
END FUNCTION


END MODULE

